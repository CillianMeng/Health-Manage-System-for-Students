# 睡眠记录功能实现总结

## 新增功能概述

已成功为学生健康管理系统添加了完整的睡眠记录管理功能，包括：

### 1. 数据模型 (SleepRecord)

- **用户关联**: 每条睡眠记录关联到具体用户
- **日期记录**: 支持记录具体的睡眠日期
- **时间记录**: 记录入睡时间和起床时间
- **自动计算**: 系统自动计算睡眠时长
- **跨日处理**: 智能处理跨日睡眠（如晚上23:30睡，早上7:00起）
- **唯一约束**: 每个用户每天只能有一条记录

### 2. API 接口

#### 睡眠记录管理
- `GET /user/sleep-records/` - 获取睡眠记录列表（支持分页和时间范围）
- `POST /user/sleep-records/create/` - 创建睡眠记录
- `GET /user/sleep-records/{id}/` - 获取单条记录详情
- `PUT /user/sleep-records/{id}/` - 更新睡眠记录
- `DELETE /user/sleep-records/{id}/` - 删除睡眠记录

#### 统计分析
- `GET /user/sleep-statistics/` - 获取睡眠统计数据
  - 平均睡眠时长
  - 总睡眠时长
  - 最长/最短睡眠记录
  - 记录总数

### 3. 用户认证整合

- **Session认证**: 所有睡眠记录API都需要用户登录
- **用户隔离**: 用户只能访问自己的睡眠记录
- **自动关联**: 创建记录时自动关联当前登录用户

### 4. 数据验证

- **日期验证**: 不允许记录未来的睡眠数据
- **重复检查**: 防止同一天创建多条记录
- **时间格式**: 标准的时间格式验证
- **用户权限**: 确保用户只能操作自己的数据

## 技术特性

### 自动计算睡眠时长
```python
def save(self, *args, **kwargs):
    if self.sleep_time and self.wake_time:
        sleep_datetime = datetime.combine(self.date, self.sleep_time)
        wake_datetime = datetime.combine(self.date, self.wake_time)
        
        # 处理跨日情况
        if self.wake_time < self.sleep_time:
            wake_datetime += timedelta(days=1)
        
        self.sleep_duration = wake_datetime - sleep_datetime
```

### 灵活的查询参数
- `days`: 查询最近N天的记录
- `page` & `page_size`: 分页支持
- 支持按日期范围查询

### 统计分析功能
- 计算平均睡眠时长
- 识别最长和最短睡眠
- 提供时间范围统计

## 前端对接建议

### 1. 睡眠记录页面
```javascript
// 获取最近30天的睡眠记录
const records = await getSleepRecords(30, 1, 10);

// 创建新的睡眠记录
await createSleepRecord('2025-07-27', '23:30:00', '07:00:00');
```

### 2. 统计分析页面
```javascript
// 获取最近7天的睡眠统计
const stats = await getSleepStatistics(7);
console.log(`平均睡眠: ${stats.statistics.average_sleep_hours}小时`);
```

### 3. 路由守卫
所有睡眠相关页面都应该添加登录检查：
```javascript
// 在访问睡眠记录页面前检查登录状态
const loginStatus = await checkLogin();
if (!loginStatus.is_logged_in) {
    router.push('/login');
}
```

## 数据库结构

```sql
CREATE TABLE user_sleeprecord (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL REFERENCES user_user(id),
    date DATE NOT NULL,
    sleep_time TIME NOT NULL,
    wake_time TIME NOT NULL,
    sleep_duration INTERVAL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    UNIQUE(user_id, date)
);
```

## 使用示例

### 1. 创建睡眠记录
```bash
curl -X POST http://localhost:8000/user/sleep-records/create/ \
  -H "Content-Type: application/json" \
  --cookie-jar cookies.txt --cookie cookies.txt \
  -d '{
    "date": "2025-07-27",
    "sleep_time": "23:30:00",
    "wake_time": "07:00:00"
  }'
```

### 2. 获取统计数据
```bash
curl -X GET "http://localhost:8000/user/sleep-statistics/?days=7" \
  --cookie cookies.txt
```

## 安全考虑

1. **用户隔离**: 每个用户只能访问自己的睡眠记录
2. **会话验证**: 所有API都检查用户登录状态
3. **数据验证**: 防止无效数据和重复记录
4. **CSRF保护**: 使用Django内置的CSRF保护

## 性能优化

1. **数据库索引**: user_id和date字段的联合索引
2. **分页查询**: 避免一次性加载大量数据
3. **查询优化**: 使用select_related减少数据库查询

这个睡眠记录功能为学生健康管理系统提供了坚实的基础，支持完整的CRUD操作和统计分析，为后续的健康数据分析和可视化功能奠定了良好的基础。
