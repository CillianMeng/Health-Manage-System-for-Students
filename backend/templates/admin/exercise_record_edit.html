{% extends 'admin/base.html' %}

{% block title %}编辑运动记录 - 学生健康管理系统{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        编辑运动记录
    </div>
    <div class="card-body">
        <form method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label for="user_id">选择用户 *</label>
                <select id="user_id" name="user_id" class="form-control" required>
                    <option value="">请选择用户</option>
                    {% for user in users %}
                        <option value="{{ user.id }}" {% if user.id == record.user.id %}selected{% endif %}>
                            {{ user.userName }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="date">日期 *</label>
                <input type="date" id="date" name="date" class="form-control" 
                       required max="{{ today|date:'Y-m-d' }}" value="{{ record.date|date:'Y-m-d' }}">
            </div>
            
            <div class="form-group">
                <label for="exercise_type">运动类型 *</label>
                <select id="exercise_type" name="exercise_type" class="form-control" required>
                    <option value="">请选择运动类型</option>
                    {% for value, display in exercise_type_choices %}
                        <option value="{{ value }}" {% if value == record.exercise_type %}selected{% endif %}>{{ display }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="duration_minutes">运动时长（分钟）*</label>
                <input type="number" id="duration_minutes" name="duration_minutes" class="form-control" 
                       required min="1" max="600" value="{{ record.duration_minutes }}">
                <small class="form-text text-muted">请输入1-600分钟之间的数值</small>
            </div>
            
            <div class="form-group">
                <label for="calories_burned">消耗卡路里 *</label>
                <input type="number" id="calories_burned" name="calories_burned" class="form-control" 
                       required min="1" max="3000" value="{{ record.calories_burned }}">
                <small class="form-text text-muted">请输入1-3000之间的数值</small>
            </div>
            
            <div class="form-group">
                <label for="notes">备注</label>
                <textarea id="notes" name="notes" class="form-control" rows="3" 
                          placeholder="可以记录运动的详细情况、感受等（可选）">{{ record.notes }}</textarea>
            </div>
            
            <div style="margin-top: 2rem;">
                <button type="submit" class="btn btn-success">保存修改</button>
                <a href="{% url 'admin_exercise_records' %}" class="btn btn-secondary">取消</a>
                <a href="{% url 'admin_exercise_record_detail' record.id %}" class="btn btn-info">查看详情</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.form-text {
    margin-top: 0.25rem;
    color: #6c757d;
}

.btn-secondary, .btn-info {
    text-decoration: none;
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    margin-left: 1rem;
    transition: background-color 0.3s;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
    color: white;
    text-decoration: none;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
}

.btn-info:hover {
    background-color: #138496;
    color: white;
    text-decoration: none;
}

textarea.form-control {
    resize: vertical;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 根据运动类型预设卡路里消耗建议
document.addEventListener('DOMContentLoaded', function() {
    const exerciseTypeSelect = document.getElementById('exercise_type');
    const durationInput = document.getElementById('duration_minutes');
    const caloriesInput = document.getElementById('calories_burned');
    
    // 各种运动的平均卡路里消耗（每分钟）
    const caloriesPerMinute = {
        'running': 10,
        'walking': 4,
        'cycling': 8,
        'swimming': 12,
        'basketball': 9,
        'football': 9,
        'tennis': 7,
        'badminton': 6,
        'yoga': 3,
        'fitness': 6,
        'dancing': 5,
        'climbing': 11,
        'other': 5
    };
    
    function updateCaloriesEstimate() {
        const exerciseType = exerciseTypeSelect.value;
        const duration = parseInt(durationInput.value) || 0;
        
        if (exerciseType && duration && caloriesPerMinute[exerciseType]) {
            const estimate = Math.round(duration * caloriesPerMinute[exerciseType]);
            // 只在用户选择运动类型时才更新卡路里，避免覆盖已有数据
            if (exerciseTypeSelect.dataset.changed === 'true') {
                caloriesInput.value = estimate;
                exerciseTypeSelect.dataset.changed = 'false';
            }
        }
    }
    
    exerciseTypeSelect.addEventListener('change', function() {
        this.dataset.changed = 'true';
        updateCaloriesEstimate();
    });
    
    durationInput.addEventListener('input', updateCaloriesEstimate);
});
</script>
{% endblock %}
